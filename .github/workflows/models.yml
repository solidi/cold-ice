name: Model Test

on: [push]

env:
  # Configuration type to build.
  # You can convert this to a build matrix if you need coverage of multiple configuration types.
  # https://docs.github.com/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
  BUILD_CONFIGURATION: Release

jobs:
  compile_tools:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Compile tools
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: |
        .\workspace\Build-Tools.ps1
        $binFolder =  ".\workspace\bin"
        $zipFile = ".\workspace\tools.zip"
        [void](New-Item -Force -ItemType Directory $env:TEMP\bin)
        Copy-Item -Recurse -Force $binFolder $env:TEMP
        Compress-Archive -LiteralPath $env:TEMP\bin -DestinationPath $zipFile -Force

    - name: Upload tools
      uses: actions/upload-artifact@v2
      with:
        name: compiled_tools
        path: ./workspace/tools.zip

  compile_models:
    runs-on: windows-latest
    needs: [compile_tools]

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Download tools
      uses: actions/download-artifact@v2
      with:
        name: compiled_tools
        path: ./workspace

    - name: Place tools
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: |
        Expand-Archive -Path .\workspace\tools.zip -DestinationPath $env:TEMP
        ls $env:TEMP\bin
        Move-Item $env:TEMP\bin .\workspace
        ls workspace\bin
        Remove-Item .\workspace\tools.zip -Recurse -Force -ErrorAction Ignore

    - name: Compile Models
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: |
        .\workspace\Build-Models.ps1
        $redistDir =  ".\redist"
        $redistHdDir =  ".\redist_hd"
        $zipFile = ".\models.zip"
        [void](New-Item -Force -ItemType Directory $env:TEMP\release)
        Copy-Item -Recurse -Force $redistHdDir\models $env:TEMP\release
        Rename-Item $env:TEMP\release\models $env:TEMP\release\models_hd
        Copy-Item -Recurse -Force $redistDir\models $env:TEMP\release
        Compress-Archive -LiteralPath $env:TEMP\release\models -DestinationPath $zipFile -Force
        Compress-Archive -LiteralPath $env:TEMP\release\models_hd -DestinationPath $zipFile -Update

    - name: Upload models
      uses: actions/upload-artifact@v2
      with:
        name: compiled_models
        path: ./workspace/models.zip

  unpack_models:
    runs-on: windows-latest
    needs: [compile_models]

    steps:
    - name: Download models
      uses: actions/download-artifact@v2
      with:
        name: compiled_models
        path: ./workspace

    - name: Place models
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: |
        Expand-Archive -Path .\workspace\models.zip -DestinationPath $env:TEMP
        Move-Item $env:TEMP\models .\workspace\redist\models
        Move-Item $env:TEMP\models_hd .\workspace\redist_hd\models
        Remove-Item .\workspace\models.zip -Recurse -Force -ErrorAction Ignore
